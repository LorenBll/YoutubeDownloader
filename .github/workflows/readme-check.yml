name: Check README Update Needed

on:
  push:
    branches:
      - '**'  # Run on all branches

jobs:
  check-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for diff
          
      - name: Get changed files
        id: changed-files
        run: |
          # Get the list of changed files in this push
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            # New branch, compare with HEAD~1
            CHANGED_FILES=$(git diff --name-only HEAD~1 2>/dev/null || git ls-files)
          else
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Check if README was modified
          README_CHANGED=$(echo "$CHANGED_FILES" | grep -i "^README" || echo "")
          
          # Check if source files were modified
          SRC_CHANGED=$(echo "$CHANGED_FILES" | grep "^src/" || echo "")
          
          # Save to output
          echo "readme_changed=$( [ -n "$README_CHANGED" ] && echo "true" || echo "false" )" >> $GITHUB_OUTPUT
          echo "src_changed=$( [ -n "$SRC_CHANGED" ] && echo "true" || echo "false" )" >> $GITHUB_OUTPUT
          
          # Save all changed files for AI analysis
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      - name: Get commit diff
        id: get-diff
        if: steps.changed-files.outputs.src_changed == 'true'
        run: |
          # Get the actual diff content
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            DIFF=$(git diff HEAD~1 2>/dev/null | head -c 8000 || echo "New branch")
          else
            DIFF=$(git diff ${{ github.event.before }} ${{ github.sha }} | head -c 8000)
          fi
          
          # Save diff to file for AI analysis
          echo "$DIFF" > diff.txt
          
      - name: Analyze changes with AI
        id: ai-analysis
        if: steps.changed-files.outputs.src_changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Read the diff
          DIFF=$(cat diff.txt)
          
          # Create prompt for AI
          PROMPT="Analyze the following git diff and determine if these changes include user-facing features, bug fixes, or important changes that should be documented in a README file. Consider:
          - New features or commands
          - Changed behavior or interfaces
          - Bug fixes that affect user experience
          - New dependencies or requirements
          - Breaking changes
          
          Respond with ONLY 'YES' if the README should be updated, or 'NO' if the changes are internal/minor.
          
          Git diff:
          $DIFF"
          
          # Call GitHub Models API (free AI access provided by GitHub)
          PROMPT_JSON=$(echo "$PROMPT" | jq -Rs .)
          RESPONSE=$(curl -s https://models.inference.ai.azure.com/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -d @- <<EOF
{
  "model": "gpt-4o-mini",
  "messages": [
    {
      "role": "system",
      "content": "You are a technical documentation assistant. Analyze code changes and determine if README updates are needed."
    },
    {
      "role": "user",
      "content": $PROMPT_JSON
    }
  ],
  "temperature": 0.3,
  "max_tokens": 10
}
EOF
)
          
          # Extract the answer
          ANSWER=$(echo "$RESPONSE" | jq -r '.choices[0].message.content' | tr -d '[:space:]' | tr '[:lower:]' '[:upper:]')
          
          echo "AI Analysis Result: $ANSWER"
          echo "needs_update=$ANSWER" >> $GITHUB_OUTPUT
          
      - name: Create issue if README needs update
        if: |
          steps.changed-files.outputs.src_changed == 'true' &&
          steps.changed-files.outputs.readme_changed == 'false' &&
          steps.ai-analysis.outputs.needs_update == 'YES'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: existingIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'documentation,readme-update'
            });
            
            // Check if there's already an open issue about README update
            const hasOpenIssue = existingIssues.some(issue => 
              issue.title.includes('README Update Needed')
            );
            
            if (!hasOpenIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸ“ README Update Needed',
                body: `## README Update Required
                
An AI analysis of recent changes suggests the README file should be updated.

**Commit:** ${context.sha.substring(0, 7)}
**Branch:** ${context.ref.replace('refs/heads/', '')}
**Pusher:** @${context.actor}

**Changed files:**
\`\`\`
${{ steps.changed-files.outputs.changed_files }}
\`\`\`

**Reason:** The recent changes include user-facing features or important modifications that should be documented in the README.

Please review the changes and update the README accordingly. Once updated, this issue can be closed.

[View commit](${context.payload.repository.html_url}/commit/${context.sha})`,
                labels: ['documentation', 'readme-update']
              });
              
              core.notice('Created issue to update README');
            } else {
              core.notice('README update issue already exists');
            }
            
      - name: Summary
        if: always()
        run: |
          echo "### README Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Source files changed: ${{ steps.changed-files.outputs.src_changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- README changed: ${{ steps.changed-files.outputs.readme_changed }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.ai-analysis.outputs.needs_update }}" = "YES" ]; then
            echo "- AI analysis: âš ï¸ README update recommended" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.ai-analysis.outputs.needs_update }}" = "NO" ]; then
            echo "- AI analysis: âœ… No README update needed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- AI analysis: Skipped (no source changes)" >> $GITHUB_STEP_SUMMARY
          fi
